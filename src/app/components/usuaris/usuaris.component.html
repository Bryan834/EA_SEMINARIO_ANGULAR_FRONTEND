<div class="container">
  <!-- Formulario a la izquierda -->
  <div class="form-container">
    <h1>{{ indiceEdicion !== null ? 'Editar usuario' : 'Agregar un nuevo usuario' }}</h1>

    <form (ngSubmit)="agregarElemento(userForm)" #userForm="ngForm">
      <div class="form-group">
        <label for="nombre">Nombre:</label>
        <input
          id="nombre"
          [(ngModel)]="nuevoUsuario.username"
          name="name"
          placeholder="Nombre del usuario"
          required />
        <div *ngIf="userForm.controls['name']?.invalid && (userForm.controls['name']?.touched || formSubmitted)" class="error-message">
          El nombre es obligatorio.
        </div>
      </div>

      <div class="form-group">
        <label for="mail">Email:</label>
        <input
          id="mail"
          [(ngModel)]="nuevoUsuario.gmail"
          name="mail"
          placeholder="Email"
          required
          email />
        <div *ngIf="userForm.controls['mail']?.invalid && (userForm.controls['mail']?.touched || formSubmitted)" class="error-message">
          {{ userForm.controls['mail'].errors?.['required'] ? 'El email es obligatorio.' : 'Formato de email no v치lido.' }}
        </div>
      </div>

      <div class="form-group">
        <label for="password">Contrase침a:</label>
        <input
          id="password"
          [(ngModel)]="nuevoUsuario.password"
          name="password"
          type="password"
          placeholder="Password"
          required
          minlength="7" />
        <div *ngIf="userForm.controls['password']?.invalid && (userForm.controls['password']?.touched || formSubmitted)" class="error-message">
          {{ userForm.controls['password'].errors?.['required'] ? 'La contrase침a es obligatoria.' : 'La contrase침a debe tener al menos 7 caracteres.' }}
        </div>
      </div>

      <div class="form-group">
        <label for="confirmarPassword">Confirmar Contrase침a:</label>
        <input
          id="confirmarPassword"
          [(ngModel)]="confirmarPassword"
          name="confirmarPassword"
          type="password"
          placeholder="Confirmar Password"
          required
          minlength="7" />
        <div *ngIf="confirmarPassword !== nuevoUsuario.password && confirmarPassword.length > 0 && formSubmitted" class="error-message">
          Las contrase침as no coinciden.
        </div>
      </div>

      <!-- 游댳 Input de fecha como string "YYYY-MM-DD", enlazado a birthdayStr -->
      <div class="form-group">
        <label for="birthday">Aniversario:</label>
        <input
          id="birthday"
          type="date"
          [(ngModel)]="birthdayStr"
          name="birthday" />
      </div>

      <button
        type="submit"
        class="submit-button"
        [disabled]="!userForm.valid">
        {{ indiceEdicion !== null ? 'Actualizar' : 'Agregar' }}
      </button>
    </form>
  </div>

  <!-- Lista de usuarios a la derecha -->
  <div class="lista-usuarios">
    <h2>Lista de Usuarios</h2>
    <ul>
      <li *ngFor="let usuario of usuarios; let i = index">
        <div class="user-info">
          <strong>{{ usuario.username }}</strong>
          <div class="button-container">
            <button (click)="toggleDesplegable(i)" class="detalles mostrar-detalles">
              {{ desplegado[i] ? 'Ocultar detalles' : 'Mostrar detalles' }}
            </button>
            <button (click)="eliminarElemento(i)" class="eliminar">Eliminar</button>
          </div>
        </div>

        <!-- Detalles del usuario -->
        <div *ngIf="desplegado[i]" class="user-details">
          <p><strong>Email:</strong> {{ usuario.gmail | maskEmail }}</p>

          <p><strong>Contrase침a:</strong>
            <span *ngIf="mostrarPassword[i]">{{ usuario.password }}</span>
            <span *ngIf="!mostrarPassword[i]">********</span>
          </p>

          <p><strong>Aniversario:</strong>
            <!-- Muestra la fecha formateada -->
            <strong>{{ usuario.birthday | date: 'yyyy-MM-dd' }}</strong>
          </p>

          <button (click)="prepararEdicion(usuario, i)" class="modificar">Modificar</button>

          <!-- Muestra los eventos del usuario (IDs o objetos) -->
          <p><strong>Eventos:</strong>
            <ng-container *ngFor="let exp of usuario.eventos">
              <span>{{ isEvento(exp) ? exp.name : exp }}</span>&nbsp;
            </ng-container>
          </p>

          <!-- Selector de eventos: el value debe ser el ID (si es objeto, usa _id) -->
          <select (change)="usuario._id ? agregarEvento(usuario._id, $event) : null">
            <option *ngFor="let exp of usuario.eventos" [value]="isEvento(exp) ? exp._id : exp">
              {{ isEvento(exp) ? ('Evento ' + exp.name) : ('Evento ' + exp) }}
            </option>
          </select>
        </div>
      </li>
    </ul>
  </div>
</div>
