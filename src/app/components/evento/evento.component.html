<div class="evento-container">

  <!-- 🔹 Sección Crear Evento -->
  <div class="accordion-section">
    <button class="accordion-header" (click)="toggleSection('create')">
      🆕 Crear Evento
      <span>{{ openSection === 'create' ? '▲' : '▼' }}</span>
    </button>

    <div class="accordion-content" [class.open]="openSection === 'create'">
      <form class="evento-form" (ngSubmit)="onSubmit()">
        <div class="form-header">
          <h2>🗓️ Nuevo evento</h2>
        </div>

        <div class="form-group">
          <label class="form-label">Nombre del evento</label>
          <input type="text" [(ngModel)]="newEvent.name" name="name" class="form-input" required />
        </div>

        <div class="form-group">
          <label class="form-label">Dirección</label>
          <input type="text" [(ngModel)]="newEvent.address" name="address" class="form-input" required />
        </div>

        <div class="form-group schedule-row">
          <div>
            <label class="form-label">Fecha</label>
            <input type="date" [(ngModel)]="dateStr" name="date" class="form-input" />
          </div>
          <div>
            <label class="form-label">Hora</label>
            <input type="time" [(ngModel)]="timeStr" name="time" class="form-input" />
          </div>
          <button type="button" class="add-slot" (click)="setSchedule()">🕒 Establecer</button>
          <button type="button" class="remove-slot" (click)="clearSchedule()">❌ Limpiar</button>
        </div>

        <div *ngIf="newEvent.schedule?.length" class="schedule-preview">
          Horario: {{ newEvent.schedule[0] }}
        </div>

        <div class="form-two-col">
          <div class="participants-wrapper">
            <div class="participants-column">
              <h4>👥 Usuarios disponibles</h4>
              <div *ngIf="availableUsers.length; else noUsers1">
                <div *ngFor="let u of availableUsers" class="user-row">
                  <span class="user-name">{{ u.username }}</span>
                  <button type="button" class="btn-add" (click)="addParticipant(u)">➕</button>
                </div>
              </div>
              <ng-template #noUsers1><p class="empty">No hay usuarios disponibles</p></ng-template>
            </div>

            <div class="participants-column">
              <h4>✅ Participantes seleccionados</h4>
              <div *ngIf="selectedUsers.length; else noUsers2">
                <div *ngFor="let u of selectedUsers" class="user-row">
                  <span class="user-name">{{ u.username }}</span>
                  <button type="button" class="btn-remove" (click)="removeParticipant(u)">➖</button>
                </div>
              </div>
              <ng-template #noUsers2><p class="empty">No hay participantes seleccionados</p></ng-template>
            </div>
          </div>
        </div>

        <button type="submit">💾 Crear evento</button>

        <div *ngIf="errorMessage" class="error-message">
          ⚠️ {{ errorMessage }}
        </div>
      </form>
    </div>
  </div>

  <!-- 🔹 Sección Editar Evento -->
  <div class="accordion-section">
    <button class="accordion-header" (click)="toggleSection('edit')">
      ✏️ Editar Evento
      <span>{{ openSection === 'edit' ? '▲' : '▼' }}</span>
    </button>

    <div class="accordion-content" [class.open]="openSection === 'edit'">
      <form class="evento-form" *ngIf="editingEventId" (ngSubmit)="updateEvento()">
        <h2>✏️ Editando: {{ newEvent.name }}</h2>

        <div class="form-group">
          <label class="form-label">Nombre</label>
          <input type="text" [(ngModel)]="newEvent.name" name="editName" class="form-input" required />
        </div>

        <div class="form-group">
          <label class="form-label">Dirección</label>
          <input type="text" [(ngModel)]="newEvent.address" name="editAddress" class="form-input" required />
        </div>

        <div class="form-group schedule-row">
          <div>
            <label class="form-label">Fecha</label>
            <input type="date" [(ngModel)]="dateStr" name="editDate" class="form-input" />
          </div>
          <div>
            <label class="form-label">Hora</label>
            <input type="time" [(ngModel)]="timeStr" name="editTime" class="form-input" />
          </div>
          <button type="button" class="add-slot" (click)="setSchedule()">🕒 Actualizar horario</button>
        </div>

        <div *ngIf="newEvent.schedule?.length" class="schedule-preview">
          Horario actual: {{ newEvent.schedule[0] }}
        </div>

        <div class="participants-wrapper">
          <div class="participants-column">
            <h4>Usuarios disponibles</h4>
            <div *ngIf="availableUsers.length; else noUsers3">
              <div *ngFor="let u of availableUsers" class="user-row">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" class="btn-add" (click)="addParticipant(u)">➕</button>
              </div>
            </div>
            <ng-template #noUsers3><p class="empty">No hay usuarios disponibles</p></ng-template>
          </div>

          <div class="participants-column">
            <h4>Participantes del evento</h4>
            <div *ngIf="selectedUsers.length; else noUsers4">
              <div *ngFor="let u of selectedUsers" class="user-row">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" class="btn-remove" (click)="removeParticipant(u)">➖</button>
              </div>
            </div>
            <ng-template #noUsers4><p class="empty">No hay participantes seleccionados</p></ng-template>
          </div>
        </div>

        <div style="margin-top:20px;">
          <button type="submit">💾 Guardar cambios</button>
          <button type="button" class="btn-cancel" (click)="cancelEdit()">🚫 Cancelar</button>
        </div>

        <div *ngIf="errorMessage" class="error-message">
          ⚠️ {{ errorMessage }}
        </div>
      </form>

      <p *ngIf="!editingEventId" style="padding:20px; color:var(--text-secondary);">
        Selecciona un evento desde la lista para editarlo.
      </p>
    </div>
  </div>

  <!-- 🔹 Sección Lista de Eventos -->
  <div class="accordion-section">
    <button class="accordion-header" (click)="toggleSection('list')">
      📋 Lista de Eventos
      <span>{{ openSection === 'list' ? '▲' : '▼' }}</span>
    </button>

    <div class="accordion-content" [class.open]="openSection === 'list'">
      <div class="evento-list">
        <h1>📅 Eventos programados</h1>
        <ul>
          <li *ngFor="let e of eventos; let i = index">
            <h3>{{ e.name }}</h3>
            <p><strong>📍 Dirección:</strong> {{ getEventAddress(e) }}</p>
            <p><strong>🕒 Horario:</strong> {{ getScheduleText(e) }}</p>
            <p><strong>👥 Participantes:</strong> {{ getParticipantsNames(e) }}</p>

            <div class="actions">
              <button (click)="startEdit(e)">✏️ Editar</button>
              <button (click)="openDeleteModal(i)">🗑️ Eliminar</button>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 🔹 Modal de confirmación -->
  <div *ngIf="showDeleteModal" class="modal-overlay">
    <div class="modal">
      <h3>¿Eliminar evento?</h3>
      <p>Esta acción no se puede deshacer.</p>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeDeleteModal()">Cancelar</button>
        <button class="btn-confirm" (click)="confirmarEliminar()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
